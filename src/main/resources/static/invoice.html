<!-- <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa Đơn</title>
    <link rel="stylesheet" href="./css/invoice.css" />
    <style>
        /* Thêm một số kiểu CSS cơ bản để cải thiện giao diện */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #invoice {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
            max-width: 600px;
        }
        h1 {
            text-align: center;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
        .product-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .product-image {
            width: 50px;
            height: 75px;
            margin-right: 10px;
        }
        .product-info {
            flex: 1;
        }
    </style>
</head>
<body>

<div id="invoice">
    <h1>HÓA ĐƠN BÁN HÀNG</h1>
    <input type="hidden" id="order-id">
    <p><strong>Người bán:</strong> Công ty SNG Comics</p>
    <p><strong>Địa chỉ:</strong> 123 Đường ABC, Thành phố XYZ</p>
    <p><strong>Số điện thoại:</strong> 0123456789</p>
    <div id="order-details"></div>
    <button onclick="window.print()">In hóa đơn</button>
</div>

<script>
    // Hàm để lấy tham số từ URL
function getParameterByName(name) {
    const url = window.location.href;
    const paramName = name.replace(/[\\[\\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + paramName + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\\+/g, ' '));
}

// Lấy orderId từ URL và gán cho phần tử
const orderId = getParameterByName('orderId');
document.getElementById('order-id').textContent = orderId;

//     const orderId = 109; 
    function selectOrder(orderId) {
            document.getElementById('order-id').value = orderId; // Hiển thị orderId vào thẻ input
        }

    async function fetchOrderDetails() {
    
        try {
            const response = await fetch(`/api/orders/details/${orderId}`, {
                method: 'GET',
                credentials: 'include' // Gửi cookie để duy trì session
            });

            if (response.status === 401) {
                document.getElementById('order-details').innerText = 'Unauthorized: Please log in.';
                return;
            }

            if (response.status === 404) {
                document.getElementById('order-details').innerText = 'Order not found.';
                return;
            }

            const order = await response.json();
            displayOrderDetails(order);
        } catch (error) {
            console.error('Error fetching order details:', error);
            document.getElementById('order-details').innerText = 'Error fetching order details.';
        }
    }

    function formatPrice(price) {
        return price.toLocaleString('vi-VN'); // Định dạng giá tiền theo kiểu VNĐ
    }
    function displayOrderDetails(order) {
    const orderDetailsDiv = document.getElementById('order-details');
    
    const orderInfo = `
        <strong>Họ và Tên:</strong> ${order.fullName}<br>
        <strong>Số điện thoại:</strong> ${order.phoneNumber}<br>
        <strong>Địa chỉ:</strong> ${order.address}, ${order.ward}, ${order.district}, ${order.province}<br>
        ${order.items.map(renderItem).join('')}
    `;

    orderDetailsDiv.innerHTML = orderInfo;
}

function renderItem(item) {
    const totalItemPrice = item.price * item.quantity;
    
    return `
        <span class="product-name"><strong>Sản phẩm:</strong> ${item.comic.name}</span><br>
        <span class="product-price"><strong>Giá:</strong> ${formatPrice(item.price)} VNĐ</span><br>
        <span class="product-quantity"><strong>Số lượng:</strong> ${item.quantity}</span><br>
        <span class="product-item-total"><strong>Tổng thành tiền:</strong> ${formatPrice(totalItemPrice)} VNĐ</span><br>
    `;
}

// Gọi hàm để lấy thông tin đơn hàng
fetchOrderDetails(orderId);

</script>

</body>
</html> -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa Đơn</title>
    <link rel="stylesheet" href="./css/invoice.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #invoice {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
        .info-section {
            margin-bottom: 20px;
        }
        .info-section p {
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table thead th {
            border-bottom: 2px solid #000;
            padding: 10px;
            text-align: left;
        }
        table tbody td {
            border-bottom: 1px solid #ccc;
            padding: 10px;
        }
        .total-price {
            text-align: right;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="invoice">
    <h1>HÓA ĐƠN BÁN HÀNG</h1>
    <div class="info-section">
        <p><strong>Người bán:</strong> Công ty SNG Comics</p>
        <p><strong>Địa chỉ:</strong> 123 Đường ABC, Thành phố XYZ</p>
        <p><strong>Liên hệ:</strong> 0123456789</p>
    </div>
    <div id="customer-info" class="info-section"></div>
    <table id="order-table">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <!-- Cột tổng giá tiền cho mỗi hai sản phẩm -->
                <th id="extra-column" style="display: none;">Tổng cho 2 sản phẩm</th>
            </tr>
        </thead>
        <tbody id="order-items"></tbody>
    </table>
    <div class="total-price" id="total-price"></div>
    <button onclick="window.print()">In hóa đơn</button>
</div>

<script>
    // Hàm để lấy tham số từ URL
    function getParameterByName(name) {
        const url = window.location.href;
        const paramName = name.replace(/[\\[\\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + paramName + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\\+/g, ' '));
    }

    // Lấy orderId từ URL
    const orderId = getParameterByName('orderId');

    // Hàm định dạng giá tiền
    function formatPrice(price) {
        return price.toLocaleString('vi-VN') + ' VNĐ';
    }

    // Hàm hiển thị thông tin khách hàng
    function displayCustomerInfo(order) {
        const customerInfoDiv = document.getElementById('customer-info');
        customerInfoDiv.innerHTML = `
            <p><strong>Họ và Tên:</strong> ${order.fullName}</p>
            <p><strong>Số điện thoại:</strong> ${order.phoneNumber}</p>
            <p><strong>Địa chỉ:</strong> ${order.address}, ${order.ward}, ${order.district}, ${order.province}</p>
             <p><strong>Hình thức thanh toán:</strong> ${order.payment ? order.payment : 'Thanh toán khi nhận hàng'}</p>
        `;
    }

    // Hàm hiển thị chi tiết đơn hàng
    function displayOrderDetails(order) {
        const orderItemsTbody = document.getElementById('order-items');
        let totalPrice = 0;
        let totalPriceForTwo = 0;

        order.items.forEach((item, index) => {
            const itemTotalPrice = item.price * item.quantity;
            totalPrice += itemTotalPrice;
            totalPriceForTwo += itemTotalPrice;

            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${item.comic.name}</td>
                <td>${formatPrice(item.price)}</td>
                <td>${item.quantity}</td>
                <td>${formatPrice(itemTotalPrice)}</td>
            `;

            // Nếu đơn hàng có hơn 2 sản phẩm, thêm cột tổng cho mỗi hai sản phẩm
            if (order.items.length > 2) {
                document.getElementById('extra-column').style.display = 'table-cell';

                // Thêm cột tổng cho mỗi hai sản phẩm
                if ((index + 1) % 2 === 0 || index === order.items.length - 1) {
                    row.innerHTML += `<td rowspan="2">${formatPrice(totalPriceForTwo)}</td>`;
                    totalPriceForTwo = 0;
                } else {
                    row.innerHTML += `<td></td>`;
                }
            }

            orderItemsTbody.appendChild(row);
        });

        // Hiển thị tổng giá trị đơn hàng
        document.getElementById('total-price').textContent = `Tổng cộng: ${formatPrice(totalPrice)}`;
    }

    // Hàm lấy thông tin đơn hàng từ API
    async function fetchOrderDetails() {
        try {
            const response = await fetch(`/api/orders/details/${orderId}`, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.status === 401) {
                alert('Unauthorized: Please log in.');
                return;
            }

            if (response.status === 404) {
                alert('Order not found.');
                return;
            }

            const order = await response.json();
            displayCustomerInfo(order);
            displayOrderDetails(order);
        } catch (error) {
            console.error('Error fetching order details:', error);
            alert('Error fetching order details.');
        }
    }

    // Gọi hàm để lấy thông tin đơn hàng
    if (orderId) {
        fetchOrderDetails();
    } else {
        alert('Không tìm thấy orderId trên URL.');
    }
</script>

</body>
</html>
