<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/styles.css" />
    
    <title>Trang Thanh Toán</title>
    <style>
      
        .main {
            display: flex;
            align-items: center;
            flex-direction: column;
            flex-grow: 1;
        }
        .TTin, .SP, .payment{
            width: 700px;
            margin-top: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .product-list {
            margin-top: 20px;
        }
        .product-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        .product-image {
            width: 80px;
            height: auto;
            margin-right: 15px;
        }
        .product-info {
            flex-grow: 1;
        }
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .product-price {
            color: green;
            
        }
        .product-total{
            color: blue;
        }
        .final-total {
            text-align: right;
            font-size: 20px;
            font-weight: bold;
            color: red;
            margin-top: 20px;
        }
        .checkout-button {
    background-color: red;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
    margin-top: 10px;
   margin-left: 80%;
    width: 20%;
    
}

.checkout-button:hover {
    background-color: darkgreen;
}
h2 {
    border-bottom: 1px solid gray; /* Tạo đường kẻ màu đỏ phía dưới tiêu đề */
    padding-bottom: 10px; /* Tạo khoảng cách giữa nội dung tiêu đề và đường kẻ */
    margin-bottom: 20px; /* Tạo khoảng cách giữa tiêu đề và nội dung bên dưới */
    font-size: 15px;
}
  

.radio-container {
    display: flex !important;
    align-items: center !important;
  
}

.radio-container input[type="radio"] {
    margin-right: 10px; /* Tạo khoảng cách giữa nút radio và chữ */
}

.radio-container label {
    white-space: nowrap;
    font-weight: normal;
    vertical-align: middle;
}

@media (max-width: 1024px) {
    
   .TTin,.SP, .payment{
    width: 90%;
   }
   .checkout-button{
    width: 15%;
    font-size: 16px;
   }
   .final-total{
    margin-right: 5% !important;

   }
   
}
@media (max-width: 768px) {
    .TTin,.SP, .payment{
    width: 100%;
    border-radius: 0px !important;
    margin-top: 5px !important;
    margin-bottom: 0px !important;
   }
   .final-total{
    margin-right: 5% !important;

   }
   .checkout-button{
    font-size: 15px;
   }
}
@media (max-width: 530px) {
    .final-total{
    margin-right: 5% !important;
    font-size: 14px;
   }
   .checkout-button{
    font-size: 11px;
    margin-left: 70%;
    width: 25%;
   }
   #o1,#o2{
    font-size: 14px !important;
   
   }
   .form-group{
    font-size: 14px !important;
   }
   #fullName,#phoneNumber,#province,#district,#ward,#address{
    font-size: 13px !important;
   }
   .TTin,.SP,.payment{
    border-radius: 0%;
    margin-top: 5px;
   }
   H2{
    font-size: 14px;
   }
   .product-list{
    font-size: 13px !important;
   }
   .product-image {
            width: 60px;
            height: auto;
            margin-right: 15px;
        }
}




    </style>
</head>
<body>
    <div class="container">
        <div id="header"></div>
        <main class="main">
            <div class="TTin">
                <h2>ĐỊA CHỈ GIAO HÀNG</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="fullName">Họ và Tên:</label>
                        <input type="text" id="fullName" name="fullName" required />
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Số điện thoại:</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required />
                    </div>
                    <div class="form-group">
                        <label for="province">Tỉnh/Thành phố:</label>
                        <select id="province" name="province" required>
                            <option value="">Chọn tỉnh/thành phố</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="district">Quận/Huyện:</label>
                        <select id="district" name="district" required>
                            <option value="">Chọn quận/huyện</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ward">Phường/Xã:</label>
                        <select id="ward" name="ward" required>
                            <option value="">Chọn phường/xã</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="address">Địa chỉ giao hàng:</label>
                        <input type="text" id="address" name="address" required />
                    </div>
                    
                </form>
            </div>
          
            <div class="payment">
                <h2>HÌNH THỨC THANH TOÁN</h2>
                
                <div class="radio-container" style="width: 100%; height: 50px; ">
                    <input type="radio" name="payment" id="option1" value="Thanh toán khi nhận hàng" style="width: 10%;">
                    <label for="option1" style="font-size: 18px;" id="o1">Thanh toán bằng tiền mặt khi nhận hàng</label>
                </div>
                
                <div class="radio-container" style="width: 100%; height: 50px;">
                    <input type="radio" name="payment" id="option2" value="Thanh toán trực tuyến"  style="width: 10%;">
                    <label for="option2" style="font-size: 18px;" id="o2">Thanh toán khi trực tuyến</label>
                </div>
                
            
            </div>


            
            
            
            <div class="SP">
                <div ><h2>KIỂM TRA LẠI ĐƠN HÀNG</h2></div>
                <div class="product-list" id="productList"></div>
                <div class="final-total" id="finalTotal">Tổng thành tiền: 0 VNĐ</div>
                <button id="checkoutButton" class="checkout-button">Đặt Hàng</button>
            </div>
        </main>
        <div id="footer"></div>
    </div>
  
    <script src="js/Header.js"></script>
    <script>

        // Hàm định dạng giá tiền với dấu phân cách hàng nghìn
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function loadCheckoutItems() {
            fetch('/cart/user', { // Gọi API để lấy sản phẩm từ giỏ hàng
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(items => {
                const productList = document.getElementById('productList');
                const finalTotal = document.getElementById('finalTotal');
                productList.innerHTML = '';
                let grandTotal = 0;

                // Lọc các sản phẩm có selected = true
                const selectedItems = items.filter(item => item.selected === true);

                if (selectedItems.length === 0) {
                    productList.innerHTML = '<p>Giỏ hàng trống.</p>';
                    finalTotal.textContent = 'Tổng thành tiền: 0 VNĐ';
                } else {
                    selectedItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('product-item');

                        const productImage = document.createElement('img');
                        productImage.src = item.comic.url; // Đường dẫn ảnh sản phẩm
                        productImage.classList.add('product-image');

                        const productInfo = document.createElement('div');
                        productInfo.classList.add('product-info');

                        const productName = document.createElement('div');
                        productName.classList.add('product-name');
                        productName.textContent = item.comic.name;

                        const productPrice = document.createElement('div');
                        productPrice.classList.add('product-price');
                        productPrice.textContent = `Giá: ${formatPrice(item.comic.price)} VNĐ`;

                        const productQuantity = document.createElement('div');
                        productQuantity.textContent = `Số lượng: ${item.quantity}`;

                        const productTotal = document.createElement('div');
                        productTotal.classList.add('product-total');
                        const totalItemPrice = item.comic.price * item.quantity;
                        productTotal.textContent = `Tổng tiền: ${formatPrice(totalItemPrice)} VNĐ`;

                        productInfo.appendChild(productName);
                        productInfo.appendChild(productPrice);
                        productInfo.appendChild(productQuantity);
                        productInfo.appendChild(productTotal);

                        itemDiv.appendChild(productImage);
                        itemDiv.appendChild(productInfo);
                        productList.appendChild(itemDiv);

                        grandTotal += totalItemPrice;
                    });

                    finalTotal.textContent = `Tổng thành tiền: ${formatPrice(grandTotal)} VNĐ`;
                }
            })
            .catch(error => console.error('Lỗi:', error));
        }

    // Gọi API để lấy dữ liệu tỉnh/thành phố, quận/huyện, phường/xã một lần
const provinceSelect = document.getElementById('province');
const districtSelect = document.getElementById('district');
const wardSelect = document.getElementById('ward');

let locationData = [];

// Hàm để tải dữ liệu từ API và lưu vào biến locationData
function fetchLocationData() {
    fetch('https://esgoo.net/api-tinhthanh/4/0.htm')
        .then(response => response.json())
        .then(data => {
            if (data.error === 0) {
                locationData = data.data; 
                localStorage.setItem('locationData', JSON.stringify(locationData)); 
                populateProvinces();
            } else {
                console.error('Lỗi lấy dữ liệu:', data.error_text);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
}


if (localStorage.getItem('locationData')) {
    locationData = JSON.parse(localStorage.getItem('locationData'));
    populateProvinces();
} else {
    fetchLocationData();
}

// Hàm để thêm các tỉnh/thành phố vào combobox
function populateProvinces() {
    provinceSelect.innerHTML = '<option value="">Chọn tỉnh/thành phố</option>';
    locationData.forEach(province => {
        const option = document.createElement('option');
        option.value = province.id;
        option.textContent = province.full_name;
        provinceSelect.appendChild(option);
    });
}

// Hàm để cập nhật danh sách quận/huyện khi chọn tỉnh/thành phố
function updateDistricts() {
    const selectedProvinceId = provinceSelect.value;
    districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

    const selectedProvince = locationData.find(province => province.id === selectedProvinceId);
    if (selectedProvince) {
        selectedProvince.data2.forEach(district => {
            const option = document.createElement('option');
            option.value = district.id;
            option.textContent = district.full_name;
            districtSelect.appendChild(option);
        });
    }
}

// Hàm để cập nhật danh sách phường/xã khi chọn quận/huyện
function updateWards() {
    const selectedProvinceId = provinceSelect.value;
    const selectedDistrictId = districtSelect.value;
    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

    const selectedProvince = locationData.find(province => province.id === selectedProvinceId);
    if (selectedProvince) {
        const selectedDistrict = selectedProvince.data2.find(district => district.id === selectedDistrictId);
        if (selectedDistrict) {
            selectedDistrict.data3.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.id;
                option.textContent = ward.full_name;
                wardSelect.appendChild(option);
            });
        }
    }
}

// Gán sự kiện onchange cho các select box
provinceSelect.addEventListener('change', updateDistricts);
districtSelect.addEventListener('change', updateWards);

// Gọi hàm fetchLocationData khi trang được tải
window.onload = function() {
    // Chọn option2
option1.checked = true;
    if( stValue==1)
{    
    // Lấy lại thông tin từ localStorage
const savedFullName = localStorage.getItem('fullName');
const savedPhoneNumber = localStorage.getItem('phoneNumber');
const savedProvince = localStorage.getItem('province');
const savedDistrict = localStorage.getItem('district');
const savedWard = localStorage.getItem('ward');
const savedAddress = localStorage.getItem('address');

// Gán giá trị vào các trường trong form nếu có dữ liệu trong localStorage
if (savedFullName) {
    document.getElementById('fullName').value = savedFullName;
}

if (savedPhoneNumber) {
    document.getElementById('phoneNumber').value = savedPhoneNumber;
}


if (savedAddress) {
    document.getElementById('address').value = savedAddress;
}
 // Gọi hàm để điền tỉnh/thành phố
 populateProvinces();

// Gán giá trị cho tỉnh (province) nếu có lưu trong localStorage
if (savedProvince) {
    provinceSelect.value = savedProvince;
    updateDistricts(); // Cập nhật danh sách quận/huyện dựa trên tỉnh được chọn

    // Đợi danh sách quận/huyện được tải rồi mới gán giá trị cho quận/huyện
    if (savedDistrict) {
        districtSelect.value = savedDistrict;
        updateWards(); // Cập nhật danh sách phường/xã dựa trên quận/huyện được chọn

        // Đợi danh sách phường/xã được tải rồi mới gán giá trị cho phường/xã
        if (savedWard) {
            wardSelect.value = savedWard;
        }
    }
}
// Chọn option2
option2.checked = true;

// Vô hiệu hóa option1
option1.disabled = true;

}
setTimeout(function() {
                if (stValue == 1) {
                    alert("Thanh toán thành công, vui lòng nhấn đặt hàng để hoàn thành đơn hàng.");
                }
            }, 1000);
    loadCheckoutItems();  
};
// Lấy các tham số từ URL
const urlParams = new URLSearchParams(window.location.search);
// Lấy giá trị của tham số "st"
const stValue = urlParams.get('st');
// Hàm kiểm tra số điện thoại Việt Nam hợp lệ
function isValidPhoneNumber(phoneNumber) {
        // Biểu thức chính quy cho số điện thoại Việt Nam
        const phoneRegex = /^(0[3|5|7|8|9])+([0-9]{8})$/;
        return phoneRegex.test(phoneNumber);
    }
        document.getElementById('checkoutButton').addEventListener('click', function() {
const option1 = document.getElementById('option1');   
const option2 = document.getElementById('option2');
//  // Kiểm tra xem tất cả các trường đều được nhập
const fullName = document.getElementById("fullName").value.trim();
  const phoneNumber = document.getElementById("phoneNumber").value.trim();
  const province = document.getElementById("province").value.trim();
  const district = document.getElementById("district").value.trim();
  const ward = document.getElementById("ward").value.trim();
  const address = document.getElementById("address").value.trim();
   // Lấy giá trị tổng từ finalTotal
   const totalElement = document.getElementById("finalTotal").textContent;
    const totalPrice = parseFloat(totalElement.replace(/\D/g, "")); // Loại bỏ các ký tự không phải số để lấy tổng giá trị
   // Thông tin đơn hàng
    const orderData = {
        amount: totalPrice,
        orderInfo: "Thông tin đơn hàng ví dụ"
    };
    
   
  if (!isValidPhoneNumber(phoneNumber)) {
            alert("Số điện thoại không hợp lệ. Vui lòng nhập số điện thoại hợp lệ.");
            return; // Dừng lại nếu số điện thoại không hợp lệ
        }
        if (!fullName || !phoneNumber || !province || !district || !ward || !address) {
    alert("Vui lòng điền đầy đủ thông tin.");
    return;
  }
    if(stValue==0 && option2.checked){
      
  // Lưu thông tin vào localStorage
localStorage.setItem('fullName', fullName);
localStorage.setItem('phoneNumber', phoneNumber);
localStorage.setItem('province', province);
localStorage.setItem('district', district);
localStorage.setItem('ward', ward);
localStorage.setItem('address', address);

console.log('Thông tin đã được lưu vào localStorage');
    // Gửi yêu cầu đến backend để lấy URL thanh toán
    fetch('/submitOrder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        },
        body: new URLSearchParams(orderData)
    })
    .then(response => response.text())  // Nhận URL từ backend dưới dạng plain text
    .then(paymentUrl => {
        console.log('Received Payment URL:', paymentUrl);  // Kiểm tra URL
        // Thực hiện chuyển hướng đến URL VNPAY
        window.location.href = paymentUrl;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Đã xảy ra lỗi khi xử lý thanh toán.');
    });
    }
else{ if (!fullName || !phoneNumber || !province || !district || !ward || !address) {
    alert("Vui lòng điền đầy đủ thông tin.");
    return;}        
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    console.log(paymentMethod);
      const totalElement =
            document.getElementById("finalTotal").textContent;
          const totalPrice = parseFloat(totalElement.replace(/\D/g, "")); // Lấy giá trị tổng, loại bỏ các ký tự không phải số
          const orderData1 = {
            fullName: document.getElementById("fullName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            province:
              document.getElementById("province").options[
                document.getElementById("province").selectedIndex
              ].text,
            district:
              document.getElementById("district").options[
                document.getElementById("district").selectedIndex
              ].text,
            ward: document.getElementById("ward").options[
              document.getElementById("ward").selectedIndex
            ].text,
            address: document.getElementById("address").value,
            totalPrice: totalPrice, // Hàm tính tổng giá trị giỏ hàng
            payment: paymentMethod // Thêm phương thức thanh toán
          };

          

          fetch("/api/orders/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json; charset=UTF-8",
            },
            body: JSON.stringify(orderData1),
          })
            .then((response) => {
              if (!response.ok) {
                // Kiểm tra nếu phản hồi là 409 (xung đột do số lượng không đủ)
                if (response.status === 409) {
                  return response.text().then((errorMessage) => {
                    alert(
                      "Số lượng sản phẩm trong kho đã có sự thay đổi, vui lòng thử lại."
                    ); // Hiển thị thông báo lỗi
                    // Không chuyển trang, chỉ thông báo cho người dùng
                    window.location.href = "GioHang.html";
                    throw new Error("Inventory issue: " + errorMessage); // Dừng chuỗi promise và không thực hiện các lệnh tiếp theo
                  });
                } else {
                  throw new Error("Đã xảy ra lỗi khi đặt hàng");
                }
              }
              return response.json(); // Nếu thành công, tiếp tục xử lý đơn hàng
            })
            .then((data) => {
              // Chỉ khi response.ok là true mới thực hiện phần này
              alert("Đặt hàng thành công!");
              console.log("Success:", data);
              window.location.href = "Order.html"; // Chuyển về trang Order nếu đặt hàng thành công
            })
            .catch((error) => {
              console.error("Error:", error);
            });}


// Vô hiệu hóa option1
option1.disabled = false;





});





    </script>
</body>
</html>
